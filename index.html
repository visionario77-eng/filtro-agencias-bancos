<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Filtro de AgÃªncias e Bancos ðŸŒŸ</title>
<style>
  :root{--bg:#f4f6ff;--card:#fff;--accent:#5b21b6;--muted:#6b7280;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;}
  body{margin:0;background:linear-gradient(180deg,#fbfbff,#eef2ff);color:#111;padding:12px;}
  .wrap{max-width:920px;margin:0 auto;}
  header{display:flex;gap:12px;align-items:center}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#7c3aed,#4f46e5);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:20px;box-shadow:0 10px 30px rgba(79,70,229,0.12)}
  h1{font-size:18px;margin:0}
  .byline{font-size:13px;color:var(--muted);margin-top:2px}
  .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.06);margin-top:12px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:8px}
  input[type=file]{width:100%}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  input[type=text]{padding:10px;border-radius:10px;border:1px solid #e6e9ef;min-width:140px}
  button{background:var(--accent);color:white;border:0;padding:10px 12px;border-radius:10px;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(79,70,229,0.12);color:var(--accent)}
  .small{font-size:13px;color:var(--muted)}
  .preview{max-height:360px;overflow:auto;border-radius:8px;padding:8px;border:1px dashed #eef2ff;background:#fbfbff;margin-top:8px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid #f1f3f8;text-align:left}
  th{background:#f9fbff;font-weight:700}
  .hint{background:#fff7ff;border-left:4px solid #ffd26a;padding:8px;border-radius:8px;margin-top:8px}
  .footer{font-size:13px;color:var(--muted);margin-top:8px;text-align:center}
  @media(max-width:560px){.controls{flex-direction:column} input[type=text]{width:100%}}
</style>

<!-- XLSX (SheetJS) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
</script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">FB</div>
      <div>
        <h1>Filtro de AgÃªncias e Bancos ðŸŒŸ</h1>
        <div class="byline">Por <b>visionario77 ðŸŒŸ</b> â€” tudo processado localmente, sem internet.</div>
      </div>
    </header>

    <div class="card">
      <label>1) Escolha o arquivo (PDF ou Excel .xlsx)</label>
      <input id="fileInput" type="file" accept=".pdf,.xlsx,.xls" />
      <div class="small" style="margin-top:6px">Exemplo: seu arquivo com colunas como CPF, Nome, Banco Recebe, Agencia, Conta, Telefone, Renda...</div>
      <div class="hint">Dica: se tiver Excel, funciona bem; se for PDF, o sistema detecta automaticamente (usa CPF como corte).</div>
    </div>

    <div class="card">
      <label>2) Coloque os filtros</label>
      <div class="controls">
        <input id="agenciaInput" type="text" placeholder="AgÃªncia (ex.: 3118)" />
        <input id="bancoInput" type="text" placeholder="Banco (ex.: 756 ou Caixa)" />
        <button id="filterBtn">Filtrar</button>
        <button id="exportBtn" class="ghost">Baixar CSV</button>
      </div>
      <div class="small" style="margin-top:8px">Preencha apenas um campo (AgÃªncia ou Banco) ou ambos.</div>
    </div>

    <div class="card">
      <label>3) Resultado</label>
      <div id="status" class="small">Nenhum arquivo carregado.</div>
      <div id="preview" class="preview"><div class="small">Os resultados aparecerÃ£o aqui.</div></div>
    </div>

    <div class="card">
      <label>Como usar</label>
      <ol class="small">
        <li>Escolha o arquivo PDF ou Excel.</li>
        <li>Digite a AgÃªncia e/ou Banco desejado.</li>
        <li>Clique em <b>Filtrar</b>.</li>
        <li>Baixe o resultado completo clicando em <b>Baixar CSV</b>.</li>
      </ol>
      <div class="footer">Â© visionario77 ðŸŒŸ â€” Privado, rÃ¡pido e 100% offline.</div>
    </div>
  </div>

<script>
const fileInput = document.getElementById('fileInput');
const agenciaInput = document.getElementById('agenciaInput');
const bancoInput = document.getElementById('bancoInput');
const filterBtn = document.getElementById('filterBtn');
const exportBtn = document.getElementById('exportBtn');
const preview = document.getElementById('preview');
const status = document.getElementById('status');

let rows = [];
let headers = [];

function setStatus(text){ status.textContent = text; }
function showSmall(msg){ preview.innerHTML = '<div class="small">'+msg+'</div>'; }

function renderTable(data){
  if(!data || data.length===0){ showSmall('Nenhum registro.'); return; }
  const keys = headers.length ? headers : Object.keys(data[0]);
  let html = '<table><thead><tr>' + keys.map(k=>`<th>${k}</th>`).join('') + '</tr></thead><tbody>';
  for(const r of data){
    html += '<tr>' + keys.map(k=>`<td>${(r[k]!==undefined? r[k] : '')}</td>`).join('') + '</tr>';
  }
  html += '</tbody></table>';
  preview.innerHTML = html;
}

function downloadCSV(data, filename='resultado.csv'){
  if(!data || data.length===0){ alert('Nada para baixar.'); return; }
  const keys = headers.length ? headers : Object.keys(data[0]);
  const csvRows = [keys.join(',')];
  for(const r of data){
    const line = keys.map(k => {
      const v = r[k]===undefined ? '' : String(r[k]).replace(/"/g,'""');
      return `"${v}"`;
    }).join(',');
    csvRows.push(line);
  }
  const blob = new Blob([csvRows.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },1000);
}

exportBtn.addEventListener('click', ()=>{
  if(!rows.length){ alert('Nada para exportar.'); return; }
  downloadCSV(rows, 'filtro_resultado.csv');
});

// PDF extraction
async function extractTextFromPDF(file){
  const arrayBuffer = await file.arrayBuffer();
  const loadingTask = pdfjsLib.getDocument({data: arrayBuffer});
  const pdf = await loadingTask.promise;
  let fullText = '';
  for(let p=1;p<=pdf.numPages;p++){
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();
    const strings = content.items.map(i=>i.str);
    fullText += strings.join(' ') + '\n';
  }
  return fullText;
}

// Excel parser
function parseExcel(file){
  return new Promise(async (resolve, reject) => {
    try{
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, {defval:''});
      resolve(json);
    }catch(e){ reject('Erro ao ler o Excel: ' + e.message); }
  });
}

// Normalize Excel to ensure Banco/Agencia exist, preserve all fields
function normalizeExcelRows(sheetRows){
  const possibleBanco = ['Banco Recebe','Banco','BANCO','BancoRecebe'];
  const possibleAg = ['Agencia','AgÃªncia','AGENCIA','Ag'];
  const normalized = [];
  for(const r of sheetRows){
    const nr = {...r};
    // detect Banco
    const bancoKey = Object.keys(r).find(k=>possibleBanco.some(p=>k.toLowerCase().includes(p.toLowerCase())));
    nr.Banco = bancoKey ? r[bancoKey] : (r.Banco||'');
    // detect Agencia
    const agKey = Object.keys(r).find(k=>possibleAg.some(p=>k.toLowerCase().includes(p.toLowerCase())));
    nr.Agencia = agKey ? String(r[agKey]).replace(/\D/g,'') : (r.Agencia||'');
    normalized.push(nr);
  }
  return normalized;
}

// Handle file input
fileInput.addEventListener('change', async (ev)=>{
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;
  setStatus('Lendo arquivo... aguarde');
  rows = []; headers = [];
  showSmall('Processando...');
  try{
    const name = (f.name||'').toLowerCase();
    if(name.endsWith('.pdf')){
      const text = await extractTextFromPDF(f);
      rows = text.split(/\n+/).map(t=>({Texto:t.trim()})).filter(x=>x.Texto);
      headers = ['Texto'];
      setStatus(`${rows.length} linhas lidas do PDF.`);
      renderTable(rows.slice(0,200));
    } else if(name.endsWith('.xls') || name.endsWith('.xlsx')){
      const sheet = await parseExcel(f);
      rows = normalizeExcelRows(sheet);
      headers = Object.keys(rows[0]||{});
      setStatus(`${rows.length} linhas lidas do Excel.`);
      renderTable(rows.slice(0,200));
    } else {
      throw new Error('Tipo de arquivo nÃ£o suportado.');
    }
  }catch(err){
    console.error(err);
    setStatus('Erro: ' + err);
    showSmall('Erro ao ler o arquivo. Tente outro.');
  }
});

// Filter
filterBtn.addEventListener('click', ()=>{
  const a = (agenciaInput.value||'').replace(/\D/g,'');
  const b = (bancoInput.value||'').trim().toLowerCase();
  if(!a && !b){ alert('Coloque ao menos AgÃªncia ou Banco.'); return; }

  const filtered = rows.filter(r=>{
    const ag = String(r.Agencia||r.agencia||'').replace(/\D/g,'');
    const bk = String(r.Banco||r.banco||'').toLowerCase();
    const okA = !a || ag===a;
    const okB = !b || bk.includes(b);
    return okA && okB;
  });

  setStatus(`${filtered.length} registros apÃ³s filtro.`);
  renderTable(filtered);
  rows = filtered; // mantÃ©m filtrado para exportar
});

setStatus('Pronto. Escolha o arquivo e siga as instruÃ§Ãµes acima.');
</script>
</body>
</html>
