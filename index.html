<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Filtro de AgÃªncias e Bancos ðŸŒŸ</title>
<style>
  :root{--bg:#f4f6ff;--card:#fff;--accent:#5b21b6;--muted:#6b7280;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;}
  body{margin:0;background:linear-gradient(180deg,#fbfbff,#eef2ff);color:#111;padding:12px;}
  .wrap{max-width:920px;margin:0 auto;}
  header{display:flex;gap:12px;align-items:center}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#7c3aed,#4f46e5);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:20px;box-shadow:0 10px 30px rgba(79,70,229,0.12)}
  h1{font-size:18px;margin:0}
  .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.06);margin-top:12px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:8px}
  input[type=file]{width:100%}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  input[type=text]{padding:10px;border-radius:10px;border:1px solid #e6e9ef;min-width:140px}
  button{background:var(--accent);color:white;border:0;padding:10px 12px;border-radius:10px;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(79,70,229,0.12);color:var(--accent)}
  .small{font-size:13px;color:var(--muted)}
  .preview{max-height:360px;overflow:auto;border-radius:8px;padding:8px;border:1px dashed #eef2ff;background:#fbfbff;margin-top:8px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid #f1f3f8;text-align:left}
  th{background:#f9fbff;font-weight:700}
  .footer{font-size:13px;color:var(--muted);margin-top:8px}
  @media(max-width:560px){.controls{flex-direction:column} input[type=text]{width:100%}}
</style>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB3WguIMNSsviul93HmgzJ1uj4GJGswD20",
    authDomain: "filtro-agencias-bancos.firebaseapp.com",
    projectId: "filtro-agencias-bancos",
    storageBucket: "filtro-agencias-bancos.firebasestorage.app",
    messagingSenderId: "917546706513",
    appId: "1:917546706513:web:1c476d7b7c86dbc978ba70"
  };

  const app = initializeApp(firebaseConfig);
  const storage = getStorage(app);

  window.uploadFileToFirebase = async function(file){
    const fileRef = ref(storage, 'uploads/' + file.name);
    await uploadBytes(fileRef, file);
    const url = await getDownloadURL(fileRef);
    return url;
  };
</script>

<!-- XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">FB</div>
    <div>
      <h1>Filtro de AgÃªncias e Bancos ðŸŒŸ</h1>
      <div class="small">Por visionario77 ðŸŒŸ â€” tudo processado online, rÃ¡pido e seguro.</div>
    </div>
  </header>

  <div class="card">
    <label>1) Escolha o arquivo (PDF ou Excel .xlsx/.xls)</label>
    <input id="fileInput" type="file" accept=".pdf,.xlsx,.xls" />
    <div class="small">Exemplo: colunas como CPF, Nome, Banco Recebe, AgÃªncia, Conta, Renda, Telefone...</div>
  </div>

  <div class="card">
    <label>2) Filtros</label>
    <div class="controls">
      <input id="agenciaInput" type="text" placeholder="AgÃªncia (ex.: 3118)" />
      <input id="bancoInput" type="text" placeholder="Banco (ex.: 756 ou Caixa)" />
      <button id="filterBtn">Filtrar</button>
      <button id="exportBtn" class="ghost">Baixar CSV</button>
    </div>
  </div>

  <div class="card">
    <label>3) Resultado</label>
    <div id="status" class="small">Nenhum arquivo carregado.</div>
    <div id="preview" class="preview"><div class="small">Os resultados aparecerÃ£o aqui.</div></div>
  </div>

  <div class="footer small">Â© visionario77 ðŸŒŸ â€” Privado, rÃ¡pido e 100% online.</div>
</div>

<script>
const fileInput=document.getElementById('fileInput');
const agenciaInput=document.getElementById('agenciaInput');
const bancoInput=document.getElementById('bancoInput');
const filterBtn=document.getElementById('filterBtn');
const exportBtn=document.getElementById('exportBtn');
const preview=document.getElementById('preview');
const status=document.getElementById('status');
let rows=[],headers=[];

function setStatus(t){status.textContent=t;}
function showSmall(m){preview.innerHTML='<div class="small">'+m+'</div>';}
function renderTable(data){
  if(!data.length){showSmall('Nenhum registro.');return;}
  const keys=headers.length?headers:Object.keys(data[0]);
  let html='<table><thead><tr>'+keys.map(k=>`<th>${k}</th>`).join('')+'</tr></thead><tbody>';
  data.forEach(r=>html+='<tr>'+keys.map(k=>`<td>${r[k]??''}</td>`).join('')+'</tr>');
  preview.innerHTML=html+'</tbody></table>';
}
function downloadCSV(data){
  if(!data.length){alert('Nada para baixar.');return;}
  const keys=headers.length?headers:Object.keys(data[0]);
  const csv=[keys.join(',')];
  data.forEach(r=>csv.push(keys.map(k=>`"${String(r[k]??'').replace(/"/g,'""')}"`).join(',')));
  const blob=new Blob([csv.join('\n')],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download='resultado.csv';a.click();
  URL.revokeObjectURL(a.href);
}

async function extractTextFromPDF(file){
  const buf=await file.arrayBuffer();
  const pdf=await pdfjsLib.getDocument({data:buf}).promise;
  let text='';
  for(let i=1;i<=pdf.numPages;i++){
    const p=await pdf.getPage(i);
    const c=await p.getTextContent();
    text+=c.items.map(i=>i.str).join(' ')+'\n';
  }
  return text;
}

function parseExcel(file){
  return new Promise(async(res,rej)=>{
    try{
      const buf=await file.arrayBuffer();
      const wb=XLSX.read(buf,{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const json=XLSX.utils.sheet_to_json(ws,{defval:''});
      res(json);
    }catch(e){rej(e);}
  });
}

fileInput.addEventListener('change',async ev=>{
  const f=ev.target.files[0];
  if(!f)return;
  setStatus('Lendo arquivo... aguarde.');
  rows=[];headers=[];
  try{
    const url=await window.uploadFileToFirebase(f);
    setStatus('Arquivo enviado para processamento...');
    let data=[];
    if(f.name.endsWith('.pdf')){
      const text=await extractTextFromPDF(f);
      data=text.split(/\n{2,}/).map(t=>({Texto:t}));
      headers=['Texto'];
    }else{
      data=await parseExcel(f);
      headers=Object.keys(data[0]||{});
    }
    rows=data;
    setStatus(`${rows.length} linhas carregadas com sucesso.`);
    renderTable(rows.slice(0,200));
  }catch(e){
    console.error(e);
    setStatus('Erro ao processar: '+e.message);
  }
});

filterBtn.addEventListener('click',()=>{
  const a=(agenciaInput.value||'').replace(/\D/g,'');
  const b=(bancoInput.value||'').toLowerCase();
  if(!a&&!b){alert('Coloque ao menos AgÃªncia ou Banco.');return;}
  const filtered=rows.filter(r=>{
    const ag=String(r.Agencia||r.agencia||r['AGÃŠNCIA']||'').replace(/\D/g,'');
    const ba=String(r.Banco||r.banco||r['BANCO']||'').toLowerCase();
    let okA=!a||ag===a;
    let okB=!b||ba===b;
    return okA&&okB;
  });
  setStatus(`${filtered.length} registros apÃ³s filtro.`);
  renderTable(filtered);
});

exportBtn.addEventListener('click',()=>downloadCSV(rows));
setStatus('Pronto. Escolha o arquivo e siga as instruÃ§Ãµes.');
</script>
</body>
</html>
