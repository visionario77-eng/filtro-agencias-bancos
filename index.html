<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Filtro de AgÃªncias e Bancos â€” visionario77 ðŸŒŸ</title>
<style>
  :root{--bg:#f4f6ff;--card:#fff;--accent:#6b21a8;--muted:#6b7280;font-family:Inter,system-ui,Roboto,Arial;}
  body{margin:0;background:linear-gradient(180deg,#fbfbff,#eef2ff);color:#111;padding:14px;}
  .wrap{max-width:980px;margin:0 auto;}
  header{display:flex;gap:12px;align-items:center}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#7c3aed,#5b21b6);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:20px;box-shadow:0 10px 30px rgba(79,70,229,0.12)}
  h1{font-size:18px;margin:0}
  .byline{font-size:13px;color:var(--muted);margin-top:2px}
  .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.06);margin-top:12px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:8px}
  input[type=file]{width:100%}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;align-items:center}
  input[type=text]{padding:10px;border-radius:10px;border:1px solid #e6e9ef;min-width:140px}
  button{background:var(--accent);color:white;border:0;padding:10px 12px;border-radius:10px;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(79,70,229,0.12);color:var(--accent)}
  .small{font-size:13px;color:var(--muted)}
  .preview{max-height:520px;overflow:auto;border-radius:8px;padding:8px;border:1px dashed #eef2ff;background:#fbfbff;margin-top:8px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid #f1f3f8;text-align:left}
  th{background:#f9fbff;font-weight:700;position:sticky;top:0}
  .meta{display:flex;gap:12px;align-items:center;margin-top:8px;flex-wrap:wrap}
  .download-area{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
  .footer{font-size:13px;color:var(--muted);margin-top:12px;text-align:center}
  .error{color:#b91900;background:#fff1f1;padding:8px;border-radius:8px;border:1px solid #ffd3d3}
  @media(max-width:640px){.controls{flex-direction:column} .download-area{flex-direction:column}}
</style>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- jsPDF + autoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">FB</div>
      <div>
        <h1>Filtro de AgÃªncias e Bancos ðŸŒŸ</h1>
        <div class="byline">por <b>visionario77 ðŸŒŸ</b> â€” foco em Excel (.xls / .xlsx)</div>
      </div>
    </header>

    <div class="card">
      <label>1) Escolha o arquivo (Excel .xlsx / .xls)</label>
      <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" />
      <div class="small" style="margin-top:6px">Dica importante: se o arquivo veio por WhatsApp ou Google Drive, primeiro faÃ§a o download no celular (salve em Downloads) e sÃ³ entÃ£o escolha o arquivo aqui.</div>
      <div id="fileName" class="small" style="margin-top:6px"></div>
    </div>

    <div class="card">
      <label>2) Filtros</label>
      <div class="controls">
        <input id="agenciaInput" type="text" placeholder="AgÃªncia (apenas nÃºmeros, ex.: 3118)" />
        <input id="bancoInput" type="text" placeholder="Banco (nÃºmero ex.: 756 ou nome ex.: Caixa)" />
        <button id="filterBtn">Filtrar</button>
        <button id="resetBtn" class="ghost">Recarregar original</button>
      </div>
      <div class="small" style="margin-top:8px">AgÃªncia: comparaÃ§Ã£o EXATA (somente nÃºmeros). Banco: se digitar apenas dÃ­gitos compara nÃºmero; se digitar texto compara texto (case-insensitive e aceita contains).</div>
    </div>

    <div class="card">
      <label>3) Resultado</label>
      <div id="status" class="small">Nenhum arquivo carregado.</div>
      <div id="preview" class="preview"><div class="small">A tabela aparecerÃ¡ aqui apÃ³s carregar um Excel.</div></div>
      <div class="meta">
        <div id="counts" class="small"></div>
        <div id="downloadArea" class="download-area"></div>
      </div>
    </div>

    <div class="card">
      <label>Como usar (resumido)</label>
      <ol class="small">
        <li>Baixe o arquivo no celular (se veio de Drive/WhatsApp) e escolha-o com "Escolher arquivo".</li>
        <li>Digite a agÃªncia (apenas nÃºmeros) e/ou o banco.</li>
        <li>Clique em "Filtrar", veja a tabela e clique em "Baixar CSV" ou "Baixar PDF".</li>
      </ol>
      <div id="help" class="small" style="margin-top:6px">Se o Excel nÃ£o abrir: tente salvar como .xlsx (Excel > Salvar como), entÃ£o tente novamente.</div>
      <div class="footer">Â© 2025 visionario77 ðŸŒŸ</div>
    </div>
  </div>

<script>
/* Elementos */
const fileInput = document.getElementById('fileInput');
const fileNameEl = document.getElementById('fileName');
const agenciaInput = document.getElementById('agenciaInput');
const bancoInput = document.getElementById('bancoInput');
const filterBtn = document.getElementById('filterBtn');
const resetBtn = document.getElementById('resetBtn');
const preview = document.getElementById('preview');
const status = document.getElementById('status');
const counts = document.getElementById('counts');
const downloadArea = document.getElementById('downloadArea');

let originalRows = []; // array de objetos
let currentRows = [];  // filtrados
let headers = [];      // ordem de colunas

/* util */
function setStatus(t){ status.textContent = t; }
function showError(t){ preview.innerHTML = '<div class="error">'+t+'</div>'; downloadArea.innerHTML=''; counts.textContent=''; }
function showMsg(t){ preview.innerHTML = '<div class="small">'+t+'</div>'; }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* render tabela */
function renderTable(rowsToShow){
  downloadArea.innerHTML='';
  counts.textContent = `${rowsToShow.length} linhas exibidas`;
  if(!rowsToShow || rowsToShow.length === 0){
    preview.innerHTML = '<div class="small">Nenhum registro a exibir.</div>';
    return;
  }
  if(!headers || headers.length===0) headers = Object.keys(rowsToShow[0]);
  let html = '<table><thead><tr>' + headers.map(h=>`<th>${escapeHtml(h)}</th>`).join('') + '</tr></thead><tbody>';
  for(const r of rowsToShow){
    html += '<tr>' + headers.map(h=>`<td>${escapeHtml(r[h])}</td>`).join('') + '</tr>';
  }
  html += '</tbody></table>';
  preview.innerHTML = html;

  // botÃµes de download
  const csvBtn = document.createElement('button');
  csvBtn.textContent = `ðŸ“¥ Baixar CSV (${rowsToShow.length} linhas)`;
  csvBtn.onclick = ()=> downloadCSV(rowsToShow);
  const pdfBtn = document.createElement('button');
  pdfBtn.textContent = `ðŸ“„ Baixar PDF (${rowsToShow.length} linhas)`;
  pdfBtn.onclick = ()=> downloadPDF(rowsToShow);
  downloadArea.appendChild(csvBtn);
  downloadArea.appendChild(pdfBtn);
}

/* export CSV */
function downloadCSV(rowsToExport){
  if(!rowsToExport || rowsToExport.length===0){ alert('Nada para exportar.'); return; }
  const keys = headers.length ? headers : Object.keys(rowsToExport[0]);
  const lines = [ keys.map(k=>`"${String(k).replace(/"/g,'""')}"`).join(',') ];
  for(const r of rowsToExport){
    lines.push(keys.map(k=>`"${String(r[k]??'').replace(/"/g,'""')}"`).join(','));
  }
  const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'filtro_resultado.csv'; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },1000);
}

/* export PDF via jsPDF + autotable */
async function downloadPDF(rowsToExport){
  if(!rowsToExport || rowsToExport.length===0){ alert('Nada para exportar.'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'landscape', unit:'pt', format:'a4' });
  const title = 'Filtro de AgÃªncias e Bancos â€” visionario77 ðŸŒŸ';
  doc.setFontSize(14);
  doc.text(title, 40, 40);
  doc.setFontSize(10);
  doc.text(`Gerado em: ${new Date().toLocaleString()}`, 40, 58);
  const cols = headers.length ? headers : Object.keys(rowsToExport[0]);
  const body = rowsToExport.map(r => cols.map(c => String(r[c] ?? '')));
  doc.autoTable({
    head: [cols],
    body,
    startY: 80,
    styles: { fontSize: 9, cellPadding: 4 },
    headStyles: { fillColor: [107,33,168], textColor: 255 },
    alternateRowStyles: { fillColor: [250,250,250] }
  });
  doc.save('filtro_resultado.pdf');
}

/* parse excel */
async function parseExcelFile(file){
  const arrayBuffer = await file.arrayBuffer();
  // tenta ler com SheetJS - suporta xls e xlsx
  const wb = XLSX.read(arrayBuffer, { type: 'array', cellDates:true, raw:false });
  const ws = wb.Sheets[wb.SheetNames[0]];
  // usa primeira linha como cabeÃ§alho
  const json = XLSX.utils.sheet_to_json(ws, { defval: '' });
  return json;
}

/* input file */
fileInput.addEventListener('change', async (ev)=>{
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;
  fileNameEl.textContent = `Arquivo: ${f.name}`;
  setStatus('Lendo arquivo... aguarde');
  showMsg('Processando arquivo, por favor aguarde...');
  originalRows = []; currentRows = []; headers = []; counts.textContent=''; downloadArea.innerHTML='';

  try{
    const name = (f.name||'').toLowerCase();
    if(!(name.endsWith('.xlsx') || name.endsWith('.xls') || name.endsWith('.csv'))) {
      throw new Error('Formato nÃ£o suportado. Use .xlsx, .xls ou .csv');
    }

    const parsed = await parseExcelFile(f);
    if(!parsed || parsed.length === 0){
      throw new Error('Arquivo vazio ou sem linhas legÃ­veis. Se veio do Drive/WhatsApp, baixe o arquivo primeiro no celular e tente novamente.');
    }

    // preserve headers na ordem original
    headers = Object.keys(parsed[0]);
    // normalize rows to strings
    originalRows = parsed.map(r=>{
      const out = {};
      for(const k of headers) out[k] = r[k] !== undefined && r[k] !== null ? String(r[k]) : '';
      return out;
    });

    currentRows = originalRows.slice();
    setStatus(`${originalRows.length} linhas carregadas â€” ${headers.length} colunas.`);
    renderTable(currentRows.slice(0,500));
  }catch(err){
    console.error(err);
    setStatus('Erro ao processar arquivo.');
    showError('Erro ao processar o arquivo: ' + (err && err.message ? err.message : err));
  }
});

/* filtro: agÃªncia numeric exact; banco numeric exact OR text contains */
filterBtn.addEventListener('click', ()=>{
  if(!originalRows || originalRows.length === 0){ alert('Carregue um arquivo antes de filtrar.'); return; }
  const aRaw = (agenciaInput.value || '').trim();
  const bRaw = (bancoInput.value || '').trim();
  const a = aRaw.replace(/\D/g,''); // somente dÃ­gitos
  const bIsDigits = /^\d+$/.test(bRaw);
  const b = bIsDigits ? bRaw.replace(/\D/g,'') : bRaw.toLowerCase();

  if(!a && !bRaw){ alert('Digite AgÃªncia e/ou Banco para filtrar.'); return; }

  // detectar chaves provÃ¡veis no dataset
  const sample = originalRows.find(Boolean) || {};
  const keys = Object.keys(sample);
  // procura colunas que mostrem 'agencia' e 'banco' (vÃ¡rias variantes)
  const agKey = keys.find(k => /agencia|ag[eÃª]ncia|agÃªncia|ag/i.test(k.toLowerCase())) || null;
  const bkKey = keys.find(k => /banco|banco\s*recebe|bancorecebe|institui/i.test(k.toLowerCase())) || null;

  const filtered = originalRows.filter(r=>{
    let okA = true, okB = true;
    if(a){
      const v = String( (agKey ? r[agKey] : (r['Agencia']||r['agencia']||r['AGENCIA']||'')) || '' ).replace(/\D/g,'');
      okA = (v === a);
    }
    if(bRaw){
      let rawBank = '';
      if(bkKey) rawBank = String(r[bkKey] || '');
      else rawBank = String(r['Banco'] || r['BANCO'] || r['banco'] || '');

      const bankDigits = rawBank.replace(/\D/g,'');
      const bankText = rawBank.toLowerCase();

      if(bIsDigits){
        okB = (bankDigits === b);
      } else {
        okB = (bankText === b) || (bankText.includes(b));
      }
    }
    return okA && okB;
  });

  currentRows = filtered;
  setStatus(`${filtered.length} registros apÃ³s filtro.`);
  renderTable(currentRows);
});

/* reset */
resetBtn.addEventListener('click', ()=>{
  if(!originalRows || originalRows.length===0) return;
  currentRows = originalRows.slice();
  setStatus(`${currentRows.length} registros (original).`);
  renderTable(currentRows);
});

/* inicial */
setStatus('Pronto â€” carregue um arquivo .xls/.xlsx para comeÃ§ar.');

</script>
</body>
</html>
